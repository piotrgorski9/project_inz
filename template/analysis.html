<!-- analysis.html -->

<!DOCTYPE html>
<html>

<head>
    <title>Strona Analizy</title>
    <style>
        body {
            color: red;
            background-color: white;
            font-size: 30px;
        }

        table {
            width: 80%;
            border-collapse: collapse;
            margin: 20px auto;
            display: none;
            /* Ukryj tabelę na początku */
        }

        th,
        td {
            border: 1px solid black;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .header {
            font-weight: bold;
        }

        .hidden {
            display: none;
        }
    </style>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>

<body>
    <center>
        <h1>Analysis page!</h1>
    </center>

    <!-- Przycisk do pokazania/ukrycia danych krajów -->
    <button type="button" onclick="toggleTable('country-table')">Show data</button>

    <!-- Przycisk do pokazania/ukrycia danych o emigracjach -->
    <button type="button" onclick="toggleTable('emigration-table')">Show emigrations</button>

    <!-- Tabela z danymi krajów -->
    <table id="country-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Country</th>
                <th>Capital</th>
                <th>Area</th>
                <th>Population</th>
                <th>Phone Code</th>
                <th>Continent</th>
                <th>Flag Path</th>
            </tr>
        </thead>
        <tbody>
            {% for country in countries %}
            <tr>
                <td>{{ country.id }}</td>
                <td>{{ country.country }}</td>
                <td>{{ country.capital }}</td>
                <td>{{ country.area }}</td>
                <td>{{ country.population }}</td>
                <td>{{ country.phone_code }}</td>
                <td>{{ country.continent }}</td>
                <td>{{ country.flag_path }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Tabela z danymi o emigracjach -->
    <table id="emigration-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Country ID</th>
                <th>Year</th>
                <th>Number of Emigrants</th>
            </tr>
        </thead>
        <tbody>
            {% for emigration in emigrations %}
            <tr>
                <td>{{ emigration.id }}</td>
                <td>{{ emigration.country_id }}</td>
                <td>{{ emigration.year }}</td>
                <td>{{ emigration.number_of_emigrants }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Formularz do obliczania średniej i minimalnej emigracji dla wybranego roku -->
    <form id="analysis-form">
        <label for="selected-year">Select year:</label>
        <select id="selected-year" name="selected-year">
            {% for year in unique_years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
            {% endfor %}
        </select>
        <!-- Przycisk do pokazania średniej emigracji dla wybranego roku -->
        <button type="button" onclick="calculateAverageForSelectedYear()">Calculate average emigration</button>
        <!-- Przycisk do pokazania minimalnej emigracji dla wybranego roku -->
        <button type="button" onclick="calculateMinForSelectedYear()">Calculate minimum emigration</button>
        <!-- Przycisk do pokazania maksymalnej emigracji dla wybranego roku -->
        <button type="button" onclick="calculateMaxEmigrationForYear()">Show maximum emigration for selected
            year</button>
        <!-- Przycisk do pokazania odchylenia standardowego emigracji dla wybranego roku -->
        <!-- <button type="button" onclick="calculateStandardDeviationForSelectedYear()">Calculate standard deviation of
            emigration</button> -->
        <button type="button" onclick="calculateSum()">Oblicz sumę emigrantów</button>

    </form>

    <!-- Formularz do obliczania procentu dla wybranego kraju i roku -->
    <form id="country-year-form">
        <label for="selected-country">Select country:</label>
        <select id="selected-country" name="selected-country">
            {% for country in countries %}
            <option value="{{ country.country }}">{{ country.country }}</option>
            {% endfor %}
        </select>
        <!-- Przycisk do pokazania procentu emigrantów dla wybranego kraju -->
        <button type="button" onclick="calculatePercentageForSelectedCountryAndYear()">Calculate percentage for selected
            country and year</button>
    </form>

    <!-- Nowy formularz do obliczania odchylenia standardowego dla danego kraju i zakresu lat -->
    <form id="standard-deviation-form">
        <label for="selected-country-deviation">Select country:</label>
        <select id="selected-country-deviation" name="selected-country-deviation">
            {% for country in countries %}
            <option value="{{ country.country }}">{{ country.country }}</option>
            {% endfor %}
        </select>

        <!-- Dodaj pola do wyboru zakresu lat -->
        <label for="start-year">Start year:</label>
        <select id="start-year" name="start-year">
            {% for year in unique_years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
            {% endfor %}
        </select>

        <label for="end-year">End year:</label>
        <select id="end-year" name="end-year">
            {% for year in unique_years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
            {% endfor %}
        </select>

        <!-- Przycisk do obliczania odchylenia standardowego dla danego kraju -->
        <button type="button" onclick="calculateStandardDeviationForSelectedCountry()">Calculate standard deviation for
            selected country</button>
    </form>

    <!-- Ukrywanie wyników -->
    <button type="button" onclick="hideAllResults()">Hide results</button>

    <!-- Wyświetlenie wszystkich wyników -->

    <!-- Wyświetlenie wyniku obliczonej średniej -->
    <p id="averageResult" style="display: none;"></p>

    <!-- Wyświetlenie wyniku minimalnej emigracji dla wybranego roku -->
    <p id="minResult" style="display: none;"></p>

    <!-- Wyświetlenie wyniku maksymalnej emigracji dla wybranego roku -->
    <p id="maxEmigrationResult" style="display: none;"></p>

    <!-- Wyświetlenie wyniku odchylenia standardowego dla emigrantów w wybranym roku -->
    <p id="standardDeviationResult" style="display: none;"></p>

    <!-- Wyświetlanie sumy emigrantów -->
    <div id="sumResult"></div>

    <!-- Wyświetlenie wyniku obliczonego procentu dla wybranego kraju i roku -->
    <div id="country-year-percentage-result" class="hidden">
        <p>Percentage of emigrants for selected country and year: </p>
        <p id="country-year-percentage-details"></p>
    </div>

    <p>Back to user panel</p>
    <button type="button" onclick="goBack()">Go back</button>

    <!-- Przycisk do pokazania wykresu kołowego -->
    <button type="button" onclick="showPieChart()">Show Pie Chart</button>

    <!-- Przycisk do pokazania wykresu emigracji -->
    <button type="button" onclick="showEmigrationChart()">Show Emigration Chart</button>
    
    <button id="hidePieChartButton" onclick="hidePieChart()">Hide Charts</button>

    <!-- Kontener dla wykresu kołowego -->
    <div id="pieChartContainer"></div>

    <!-- Formularz do wyboru kraju i lat -->
    <form id="emigration-form" style="display: none;">

        <!-- Kontener dla wykresu -->
        <div id="emigrationChartContainer">
            <img id="emigrationChart" src="" alt="Emigration Chart">
        </div>


        <label for="yearRange">Select start and end year:</label>
        <div id="yearRange"></div>
        <span id="selectedStartYear">2005</span>
        <span id="selectedEndYear">2022</span>

        <form id="two-countries-form">
            <label for="selected-country-1">Select Country 1:</label>
            <select id="selected-country-1" name="selected-country-1">
                {% for country in countries %}
                <option value="{{ country.country }}">{{ country.country }}</option>
                {% endfor %}
            </select>

            <label for="selected-country-2">Select Country 2:</label>
            <select id="selected-country-2" name="selected-country-2">
                {% for country in countries %}
                <option value="{{ country.country }}">{{ country.country }}</option>
                {% endfor %}
            </select>

            <!-- Przycisk do pokazania wykresu dla dwóch krajów -->
            <button type="button" onclick="showEmigrationChartForTwoCountries()">Show Emigration Chart for Two
                Countries</button>
        </form>
    </form>

    <!-- Przycisk do pokazania formularza wyboru kraju i lat -->
    <!-- <button type="button" onclick="showEmigrationForm()">Show Emigration Chart</button> -->



    <h1>NOWE</h1>

    



    <!-- Nowy formularz do wyboru dwóch krajów -->
    <!-- <form id="two-countries-form">
        <label for="selected-country-1">Select Country 1:</label>
        <select id="selected-country-1" name="selected-country-1">
            {% for country in countries %}
            <option value="{{ country.country }}">{{ country.country }}</option>
            {% endfor %}
        </select>

        <label for="selected-country-2">Select Country 2:</label>
        <select id="selected-country-2" name="selected-country-2">
            {% for country in countries %}
            <option value="{{ country.country }}">{{ country.country }}</option>
            {% endfor %}
        </select>

         Przycisk do pokazania wykresu dla dwóch krajów
        <button type="button" onclick="showEmigrationChartForTwoCountries()">Show Emigration Chart for Two
            Countries</button>
    </form>  -->

    <!-- Obliczanie sumy -->
    <!-- Przyciski i formularz dla sumy emigrantów -->
    <!-- <form id="sumForm">
        <label for="selectedYear">Wybierz rok:</label>
        <select id="selectedYear" name="selectedYear">
            {% for year in unique_years %}
            <option value="{{ year.year }}">{{ year.year }}</option>
            {% endfor %}
        </select>
         <button type="button" onclick="calculateSum()">Oblicz sumę emigrantów</button>
    </form>  -->



    <script>
        // Wyswietlanie tabel
        function toggleTable(tableId) {
            var table = document.getElementById(tableId);
            table.style.display = (table.style.display === 'none') ? 'table' : 'none';
        }

        // Obliczanie sredniej dla wybranego roku
        function calculateAverageForSelectedYear() {
            var selectedYear = document.getElementById('selected-year').value;

            // Wywołaj żądanie AJAX do Django, aby obliczyć średnią dla wybranego roku
            fetch('/calculate_average_for_year/?selected_year=' + encodeURIComponent(selectedYear))
                .then(response => response.json())
                .then(data => {
                    if ('average_emigration' in data) {
                        var averageResult = document.getElementById('averageResult');
                        averageResult.innerHTML = "Average emigration for year " + selectedYear + ": " + data.average_emigration.toFixed(2);
                        averageResult.style.display = 'block';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // Obliczanie procentu dla wybranego kraju
        function calculatePercentageForSelectedCountryAndYear() {
            var selectedCountry = document.getElementById('selected-country').value;
            var selectedYear = document.getElementById('selected-year').value;

            // Wywołaj żądanie AJAX do Django, aby obliczyć procent dla wybranego kraju i roku
            fetch('/calculate_percentage_for_country_and_year/?selected_country=' + encodeURIComponent(selectedCountry) + '&selected_year=' + encodeURIComponent(selectedYear))
                .then(response => response.json())
                .then(data => {
                    if ('percentage' in data) {
                        var countryYearPercentageDetails = document.getElementById('country-year-percentage-details');
                        countryYearPercentageDetails.innerHTML = "<p>" + selectedCountry + " in year " + selectedYear + ": " + data.percentage.toFixed(2) + "%</p>";

                        var countryYearPercentageResult = document.getElementById('country-year-percentage-result');
                        countryYearPercentageResult.style.display = 'block';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // Max wartośc dla wybranego roku
        function calculateMaxEmigrationForYear() {
            var selectedYear = document.getElementById('selected-year').value;

            // Wywołaj żądanie AJAX do Django, aby obliczyć maksymalną emigrację dla wybranego roku
            fetch('/calculate_max_emigration_for_year/?selected_year=' + encodeURIComponent(selectedYear))
                .then(response => response.json())
                .then(data => {
                    if ('max_emigration' in data && 'max_country' in data) {
                        var maxEmigrationResult = document.getElementById('maxEmigrationResult');
                        maxEmigrationResult.innerHTML = "Maximum emigration for year " + selectedYear + ": " + data.max_emigration +
                            " in country " + data.max_country;
                        maxEmigrationResult.style.display = 'block';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // Min wartośc dla wybranego roku
        function calculateMinForSelectedYear() {
            var selectedYear = document.getElementById('selected-year').value;

            // Wywołaj żądanie AJAX do Django, aby obliczyć minimalną wartość dla wybranego roku
            fetch('/calculate_min_for_year/?selected_year=' + encodeURIComponent(selectedYear))
                .then(response => response.json())
                .then(data => {
                    if ('min_emigration' in data && 'country_with_min_emigration' in data) {
                        var minResult = document.getElementById('minResult');

                        minResult.innerHTML = "Minimum emigration for year " + selectedYear + ": " + data.min_emigration +
                            " in country " + data.country_with_min_emigration;
                        minResult.style.display = 'block';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // Odchylenie standardowe dla wybranego roku
        // function calculateStandardDeviationForSelectedYear() {
        //     var selectedYear = document.getElementById('selected-year').value;

        //     // Wywołaj żądanie AJAX do Django, aby obliczyć odchylenie standardowe dla wybranego roku
        //     fetch('/calculate_standard_deviation_for_year/?selected_year=' + encodeURIComponent(selectedYear))
        //         .then(response => response.json())
        //         .then(data => {
        //             if ('standard_deviation' in data) {
        //                 var standardDeviationResult = document.getElementById('standardDeviationResult');
        //                 standardDeviationResult.innerHTML = "Standard deviation for year " + selectedYear + ": " + data.standard_deviation.toFixed(2);
        //                 standardDeviationResult.style.display = 'block';
        //             } else {
        //                 alert('An error occurred: ' + data.error);
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Error during AJAX request:', error);
        //         });
        // }

        // odchylenie dla wybranego kraju 
        function calculateStandardDeviationForSelectedCountry() {
            var selectedCountry = document.getElementById('selected-country-deviation').value;
            var startYear = document.getElementById('start-year').value;
            var endYear = document.getElementById('end-year').value;

            // Wywołaj żądanie AJAX do Django, aby obliczyć odchylenie standardowe dla danego kraju i zakresu lat
            fetch('/calculate_standard_deviation_for_country/?selected_country=' + encodeURIComponent(selectedCountry) + '&start_year=' + encodeURIComponent(startYear) + '&end_year=' + encodeURIComponent(endYear))
                .then(response => response.json())
                .then(data => {
                    if ('standard_deviation' in data) {
                        var standardDeviationResult = document.getElementById('standardDeviationResult');
                        standardDeviationResult.innerHTML = "Standard deviation for " + selectedCountry + " from " + startYear + " to " + endYear + ": " + data.standard_deviation.toFixed(2);
                        standardDeviationResult.style.display = 'block';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        function calculateSum() {
            var selectedYear = document.getElementById('selected-year').value;

            // Ukryj wyniki sumy emigrantów przed wysłaniem zapytania AJAX
            var sumResult = document.getElementById('sumResult');
            sumResult.style.display = 'none';
            sumResult.innerText = '';  // Zresetuj tekst wyniku

            // Wywołaj funkcję na backendzie i obsłuż odpowiedź
            $.get('/calculate_sum_for_year/', { selected_year: selectedYear }, function (data) {
                if ('total_emigration_for_year' in data) {
                    $('#sumResult').text('Suma emigrantów dla ' + selectedYear + ': ' + data.total_emigration_for_year);
                    // Pokaż wyniki sumy emigrantów po otrzymaniu odpowiedzi
                    sumResult.style.display = 'block';
                } else {
                    $('#sumResult').text('Błąd: ' + data.error);
                }
            });
        }




        // powrót do panelu użytkownika
        function goBack() {
            window.history.back();
        }

        // Funkcja do ukrywania wszystkich wyników
        function hideAllResults() {
            // Ukryj wyniki średniej emigracji
            var averageResult = document.getElementById('averageResult');
            averageResult.style.display = 'none';

            // Ukryj wyniki minimalnej emigracji
            var minResult = document.getElementById('minResult');
            minResult.style.display = 'none';

            // Ukryj wyniki maksymalnej emigracji
            var maxEmigrationResult = document.getElementById('maxEmigrationResult');
            maxEmigrationResult.style.display = 'none';

            // Ukryj wyniki odchylenia standardowego
            var standardDeviationResult = document.getElementById('standardDeviationResult');
            standardDeviationResult.style.display = 'none';

            // Ukryj wyniki sumy emigrantów
            var sumResult = document.getElementById('sumResult');
            sumResult.style.display = 'none';

            // Ukryj wyniki procentu dla wybranego kraju i roku
            var countryYearPercentageResult = document.getElementById('country-year-percentage-result');
            countryYearPercentageResult.style.display = 'none';
        }

        //WYKES

        // Funkcja do pokazania wykresu kołowego
        function showPieChart() {

            var pieChartContainer = document.getElementById('pieChartContainer');

            // Sprawdź, czy kontener ma klasę ukrywającą
            if (pieChartContainer.classList.contains('hidden')) {
                // Jeśli tak, usuń ją, aby wykres mógł być widoczny
                pieChartContainer.classList.remove('hidden');
            }
            var selectedYear = document.getElementById('selected-year').value;

            // Wywołaj żądanie AJAX do Django, aby pobrać dane dla wykresu
            fetch('/generate_pie_chart/' + encodeURIComponent(selectedYear) + '/')
                .then(response => response.json())
                .then(data => {
                    if ('image_base64' in data) {
                        var pieChartContainer = document.getElementById('pieChartContainer');
                        pieChartContainer.innerHTML = '<img src="data:image/png;base64,' + data.image_base64 + '" alt="Pie Chart">';
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // // Funkcja do pokazania formularza wyboru kraju i lat
        // function showEmigrationForm() {
        //     var emigrationForm = document.getElementById('emigration-form');
        //     emigrationForm.style.display = 'block';
        // }

        // // Funkcja do ukrywania formularza
        // function hideEmigrationForm() {
        //     var emigrationForm = document.getElementById('emigration-form');
        //     emigrationForm.style.display = 'none';
        // }

        // Funkcja do pokazania wykresu emigracji
        function showEmigrationChart() {
            var emigrationForm = document.getElementById('emigration-form');
            emigrationForm.style.display = 'block';
            var selectedCountry = document.getElementById('selected-country').value;

            // Pobierz wartości początkową i końcową z suwaka
            var startYear = $("#yearRange").slider("values", 0);
            var endYear = $("#yearRange").slider("values", 1);

            // Wywołaj funkcję do pobrania i wyświetlenia wykresu
            fetch('/generate_emigration_chart/' + encodeURIComponent(selectedCountry) + '/?start_year=' + encodeURIComponent(startYear) + '&end_year=' + encodeURIComponent(endYear))
                .then(response => response.json())
                .then(data => {
                    if ('image_base64' in data) {
                        var emigrationChart = document.getElementById('emigrationChart');
                        emigrationChart.src = 'data:image/png;base64,' + data.image_base64;
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        // Funkcja do obsługi suwaka z dwoma uchwytami
        function handleYearRangeChange() {
            var yearRange = $("#yearRange");
            var selectedStartYear = $("#selectedStartYear");
            var selectedEndYear = $("#selectedEndYear");

            // Pobierz wartości początkową i końcową z suwaka
            var startYear = yearRange.slider("values", 0);
            var endYear = yearRange.slider("values", 1);

            selectedStartYear.text(startYear);
            selectedEndYear.text(endYear);

            // Wywołaj funkcję do pobrania i wyświetlenia wykresu
            showEmigrationChart();
        }

        // Inicjalizacja suwaka z dwoma uchwytami
        $("#yearRange").slider({
            range: true,
            min: 2005,
            max: 2022,
            values: [2005, 2022],
            slide: function (event, ui) {
                $("#selectedStartYear").text(ui.values[0]);
                $("#selectedEndYear").text(ui.values[1]);
            },
            // stop: function (event, ui) {
            //     // Sprawdź, czy został naciśnięty przycisk
            //     if (event.originalEvent.type === 'mouseup') {
            //         // Wywołaj funkcję do pobrania i wyświetlenia wykresu po zakończeniu przesuwania suwaka
            //         showEmigrationChart();
            //     }
            // }
        });


        // nowy wykres do porównywania 

        // Zmienne do przechowywania wybranych krajów
        var selectedCountry1 = "";
        var selectedCountry2 = "";

        // Funkcja do obsługi zmiany wybranego kraju 1
        function handleCountry1Change() {
            selectedCountry1 = document.getElementById('selected-country-1').value;
        }

        // Funkcja do obsługi zmiany wybranego kraju 2
        function handleCountry2Change() {
            selectedCountry2 = document.getElementById('selected-country-2').value;
        }

        // Funkcja do obsługi formularza i generowania wykresu dla dwóch krajów
        function showEmigrationChartForTwoCountries() {
            // Pobierz wartości początkową i końcową z suwaka
            var startYear = $("#yearRange").slider("values", 0);
            var endYear = $("#yearRange").slider("values", 1);

            // Pobierz wybrane kraje z formularza
            var selectedCountry1 = document.getElementById('selected-country-1').value;
            var selectedCountry2 = document.getElementById('selected-country-2').value;

            // Wywołaj funkcję do pobrania i wyświetlenia wykresu dla dwóch krajów
            fetch('/generate_emigration_chart_for_two_countries/?country1=' + encodeURIComponent(selectedCountry1) + '&country2=' + encodeURIComponent(selectedCountry2) + '&start_year=' + encodeURIComponent(startYear) + '&end_year=' + encodeURIComponent(endYear))
                .then(response => response.json())
                .then(data => {
                    if ('image_base64' in data) {
                        var emigrationChart = document.getElementById('emigrationChart');
                        emigrationChart.src = 'data:image/png;base64,' + data.image_base64;
                    } else {
                        alert('An error occurred: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during AJAX request:', error);
                });
        }

        function hidePieChart() {
            var pieChartContainer = document.getElementById('pieChartContainer');
            pieChartContainer.classList.add('hidden');  // Dodaj klasę ukrywającą

            var emigrationForm = document.getElementById('emigration-form');
            emigrationForm.style.display = 'none';
        }



    </script>
</body>

</html>